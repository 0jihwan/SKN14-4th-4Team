<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>AI 식단 분석기</title>
    <style>
        body { font-family: sans-serif; max-width: 800px; margin: auto; padding: 20px; }
        #chatbox { border: 1px solid #ccc; height: 400px; overflow-y: scroll; padding: 10px; margin-bottom: 10px; }
        #userInput { width: 80%; padding: 8px; }
        #sendButton { padding: 8px; }
        .user-message { text-align: right; color: blue; }
        .bot-message { text-align: left; color: green; white-space: pre-wrap; }
    </style>
</head>
<body>
    <h1>AI 식단 분석기</h1>
    <div id="chatbox"></div>
    
    <form id="message-form" onsubmit="sendMessage(event)">
        {% csrf_token %}
        <input type="text" id="userInput" placeholder="음식 사진을 올리거나 음식 이름을 입력하세요...">
        <input type="file" id="imageInput" multiple accept="image/*">
        <button type="submit">전송</button>
    </form>

    <script>
        // Django의 CSRF 토큰을 가져오는 함수
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        const csrftoken = getCookie('csrftoken');

        async function sendMessage(event) {
            event.preventDefault();
            const userInput = document.getElementById('userInput');
            const imageInput = document.getElementById('imageInput');
            const chatbox = document.getElementById('chatbox');

            const userText = userInput.value;
            const userImages = imageInput.files;

            if (!userText && userImages.length === 0) return;

            // 사용자 메시지 표시
            const userDiv = document.createElement('div');
            userDiv.className = 'user-message';
            userDiv.textContent = userText || '이미지 전송됨';
            chatbox.appendChild(userDiv);

            // FormData 객체 생성
            const formData = new FormData();
            formData.append('user_text', userText);
            for (let i = 0; i < userImages.length; i++) {
                formData.append('images', userImages[i]);
            }

            try {
                // Django의 URL 경로로 수정 ('/analyze/')
                const response = await fetch('chatbot/', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrftoken // 헤더에 CSRF 토oken 추가
                    },
                    body: formData
                });
                
                const data = await response.json();

                // 봇 응답 표시
                const botDiv = document.createElement('div');
                botDiv.className = 'bot-message';
                botDiv.textContent = data.content || data.error;
                chatbox.appendChild(botDiv);

            } catch (error) {
                console.error('Error:', error);
                const errorDiv = document.createElement('div');
                errorDiv.className = 'bot-message';
                errorDiv.textContent = '오류가 발생했습니다.';
                chatbox.appendChild(errorDiv);
            }

            // 입력 필드 초기화
            userInput.value = '';
            imageInput.value = '';
            chatbox.scrollTop = chatbox.scrollHeight;
        }
    </script>
</body>
</html>