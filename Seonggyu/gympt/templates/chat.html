<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>GYM-PT - 챗봇</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'style.css' %}">
</head>
<body>
    <div style="position: absolute; top: 30px; right: 50px; z-index:10;">
        {% if user.is_authenticated %}
            <span style="font-weight:bold; margin-right:10px;">안녕하세요, {{ user.username }}님!</span>
            <a href="{% url 'logout' %}">
                <button type="button" style="padding: 6px 18px;">로그아웃</button>
            </a>
        {% else %}
            <a href="{% url 'login' %}"><button type="button" style="padding: 6px 18px; margin-right:8px;">로그인</button></a>
            <a href="{% url 'signup' %}"><button type="button" style="padding: 6px 18px;">회원가입</button></a>
        {% endif %}
    </div>
    <h2 class="chat-title">💬 GYM-PT와 대화하기</h2>

    <div class="button-container">
        <form action="{% url 'main' %}" method="get">
            <button type="submit">← 메인으로</button>
        </form>
    </div>

    <div class="chat-container">
        {% if chat_history %}
            {% for msg in chat_history %}
                {% if msg.0 == "user" %}
                <div class="chat-message user-message">
                    <strong>👤 사용자:</strong><br>{{ msg.1 }}
                </div>
                {% else %}
                <div class="chat-message assistant-message">
                    <strong>🤖 GYM-PT:</strong><br>{{ msg.1|safe }}
                </div>
                {% endif %}
            {% endfor %}
        {% endif %}
    </div>

    <hr>

    <h3>📝 새로운 메시지</h3>
    <form id="chatForm" action="{% url 'chat' %}" method="post" enctype="multipart/form-data">
        {% csrf_token %}
        <div class="upload-area">
            <label>음식 사진을 업로드해주세요 (최대 5개)</label><br><br>
            <input type="file" name="uploaded_files" multiple accept="image/*">
        </div>
        <textarea name="user_text" placeholder="예: 나이 25세, 남성, 키 175cm, 몸무게 70kg..." style="display:block; margin: 0 auto;" rows="5" cols="180"></textarea><br><br>
        <div class="button-container" style="position: relative;">
            <button id="analyzeBtn" type="submit">📤 분석 요청하기</button>
        <div id="spinner" style="display:none; margin-top:40px; justify-content: center;">
            <div style="display: flex; flex-direction: column; align-items: center;">
                <img src="{% static 'spinner.gif' %}" alt="로딩중">
            </div>
        </div>
        </div>
    </form>
    <form method="post" action="{% url 'clear_history' %}" style="display:inline;">
        {% csrf_token %}
        <button type="submit" style="float:right; margin-right:10px;">🧹 대화/식사 기록 초기화</button>
    </form>
    <script>
        document.getElementById("chatForm").onsubmit = function() {
            document.getElementById("analyzeBtn").style.display = 'none';
            document.getElementById("spinner").style.display = 'block';
        };
    </script>
    <script>
    window.onload = function() {
        var container = document.querySelector('.chat-container');
        if(container) container.scrollTop = container.scrollHeight;
    };
    </script>
    <style>
    .chat-container {
        max-height: 450px;
        overflow-y: auto;
    }
    </style>
</body>
</html>