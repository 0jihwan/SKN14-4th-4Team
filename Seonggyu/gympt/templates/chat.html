<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>GYM-PT - ì±—ë´‡</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'style.css' %}">
</head>
<body>
    <div style="position: absolute; top: 30px; right: 50px; z-index:10;">
        {% if user.is_authenticated %}
            <span style="font-weight:bold; margin-right:10px;">ì•ˆë…•í•˜ì„¸ìš”, {{ user.username }}ë‹˜!</span>
            <a href="{% url 'logout' %}">
                <button type="button" style="padding: 6px 18px;">ë¡œê·¸ì•„ì›ƒ</button>
            </a>
        {% else %}
            <a href="{% url 'login' %}"><button type="button" style="padding: 6px 18px; margin-right:8px;">ë¡œê·¸ì¸</button></a>
            <a href="{% url 'signup' %}"><button type="button" style="padding: 6px 18px;">íšŒì›ê°€ì…</button></a>
        {% endif %}
    </div>
    <h2 class="chat-title">ğŸ’¬ GYM-PTì™€ ëŒ€í™”í•˜ê¸°</h2>

    <div class="button-container">
        <form action="{% url 'main' %}" method="get">
            <button type="submit">â† ë©”ì¸ìœ¼ë¡œ</button>
        </form>
    </div>

    <div class="chat-container">
        {% if chat_history %}
            {% for msg in chat_history %}
                {% if msg.0 == "user" %}
                <div class="chat-message user-message">
                    <strong>ğŸ‘¤ ì‚¬ìš©ì:</strong><br>{{ msg.1 }}
                </div>
                {% else %}
                <div class="chat-message assistant-message">
                    <strong>ğŸ¤– GYM-PT:</strong><br>{{ msg.1|safe }}
                </div>
                {% endif %}
            {% endfor %}
        {% endif %}
    </div>

    <hr>

    <h3>ğŸ“ ìƒˆë¡œìš´ ë©”ì‹œì§€</h3>
    <form id="chatForm" action="{% url 'chat' %}" method="post" enctype="multipart/form-data">
        {% csrf_token %}
        <div class="upload-area">
            <label>ìŒì‹ ì‚¬ì§„ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš” (ìµœëŒ€ 5ê°œ)</label><br><br>
            <input type="file" name="uploaded_files" multiple accept="image/*">
        </div>
        <textarea name="user_text" placeholder="ì˜ˆ: ë‚˜ì´ 25ì„¸, ë‚¨ì„±, í‚¤ 175cm, ëª¸ë¬´ê²Œ 70kg..." style="display:block; margin: 0 auto;" rows="5" cols="180"></textarea><br><br>
        <div class="button-container" style="position: relative;">
            <button id="analyzeBtn" type="submit">ğŸ“¤ ë¶„ì„ ìš”ì²­í•˜ê¸°</button>
        <div id="spinner" style="display:none; margin-top:40px; justify-content: center;">
            <div style="display: flex; flex-direction: column; align-items: center;">
                <img src="{% static 'spinner.gif' %}" alt="ë¡œë”©ì¤‘">
            </div>
        </div>
        </div>
    </form>
    <form method="post" action="{% url 'clear_history' %}" style="display:inline;">
        {% csrf_token %}
        <button type="submit" style="float:right; margin-right:10px;">ğŸ§¹ ëŒ€í™”/ì‹ì‚¬ ê¸°ë¡ ì´ˆê¸°í™”</button>
    </form>
    <script>
        document.getElementById("chatForm").onsubmit = function() {
            document.getElementById("analyzeBtn").style.display = 'none';
            document.getElementById("spinner").style.display = 'block';
        };
    </script>
    <script>
    window.onload = function() {
        var container = document.querySelector('.chat-container');
        if(container) container.scrollTop = container.scrollHeight;
    };
    </script>
    <style>
    .chat-container {
        max-height: 450px;
        overflow-y: auto;
    }
    </style>
</body>
</html>